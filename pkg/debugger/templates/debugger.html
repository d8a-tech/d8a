<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rawlog Debugger</title>

    <!-- Bootstrap 5.3 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- JSON Diff CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsondiffpatch/formatters/styles/html.css"
        type="text/css" />

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            height: 100vh;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }

        .main-content {
            height: 100vh;
            overflow-y: auto;
        }

        .rawlog-item {
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
            margin-bottom: 2px;
            border: 1px solid #dee2e6;
        }

        .rawlog-item:hover {
            background-color: #e9ecef;
        }

        .rawlog-item.expanded {
            background-color: #f8f9fa;
            border-color: #6c757d;
        }

        .rawlog-requests {
            display: none;
            margin-top: 5px;
            padding-left: 15px;
            border-left: 2px solid #dee2e6;
        }

        .rawlog-requests.show {
            display: block;
        }

        .request-item {
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
            margin-bottom: 1px;
            padding: 8px;
            font-size: 0.85em;
            border: 1px solid transparent;
        }

        .request-item:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }

        .request-item.selected-slot1 {
            background-color: #cfe2ff;
            border-left: 4px solid #0d6efd;
        }

        .request-item.selected-slot2 {
            background-color: #d1e7dd;
            border-left: 4px solid #198754;
        }

        .expand-icon {
            transition: transform 0.2s;
            margin-right: 5px;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .comparison-slot {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            min-height: 200px;
            transition: border-color 0.2s;
        }

        .comparison-slot.has-content {
            border-style: solid;
        }

        .comparison-slot.slot1 {
            border-color: #0d6efd;
        }

        .comparison-slot.slot2 {
            border-color: #198754;
        }

        .diff-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            min-height: 300px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 12px;
        }

        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .json-display.expandable {
            max-height: 600px;
            resize: vertical;
        }

        .json-display::-webkit-scrollbar {
            width: 8px;
        }

        .json-display::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .json-display::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .json-display::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .json-container {
            position: relative;
        }

        .json-controls {
            position: absolute;
            top: 5px;
            right: 10px;
            z-index: 10;
        }

        .json-controls .btn {
            font-size: 0.75rem;
            padding: 2px 6px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .json-container:hover .json-controls .btn {
            opacity: 1;
        }

        .json-search {
            position: relative;
            margin-bottom: 10px;
        }

        .json-search input {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .json-highlight {
            background-color: #fff3cd !important;
            border-radius: 2px;
            padding: 1px 2px;
        }

        .search-box {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .badge-slot1 {
            background-color: #0d6efd;
        }

        .badge-slot2 {
            background-color: #198754;
        }

        .controls-section {
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .jsondiffpatch-delta {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* GitHub-style diff styling */
        .github-style-diff {
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            background-color: #ffffff;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            overflow-x: auto;
        }

        .diff-line {
            display: flex;
            min-height: 20px;
            align-items: center;
        }

        .diff-line-number {
            min-width: 50px;
            padding: 0 10px;
            text-align: right;
            font-size: 0.8em;
            color: #656d76;
            background-color: #f6f8fa;
            border-right: 1px solid #d1d9e0;
            user-select: none;
        }

        .diff-line-content {
            flex: 1;
            padding: 0 10px;
            white-space: pre;
            overflow-x: auto;
        }

        .diff-unchanged {
            background-color: #ffffff;
        }

        .diff-added {
            background-color: #d1f4d0;
        }

        .diff-added .diff-line-number {
            background-color: #ccfccb;
            color: #1a7f37;
        }

        .diff-removed {
            background-color: #ffd7d5;
        }

        .diff-removed .diff-line-number {
            background-color: #ffc1bc;
            color: #d1242f;
        }

        .diff-line:hover {
            background-color: #f6f8fa;
        }

        .diff-added:hover {
            background-color: #c8e6c5;
        }

        .diff-removed:hover {
            background-color: #ffc2c0;
        }

        /* Smart diff styling */
        .smart-diff-container {
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            background-color: #ffffff;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            overflow-x: auto;
        }

        .diff-item {
            border-bottom: 1px solid #f6f8fa;
            padding: 8px 12px;
        }

        .diff-item:last-child {
            border-bottom: none;
        }

        .diff-path {
            font-weight: bold;
            margin-bottom: 4px;
            color: #24292f;
        }

        .diff-value {
            padding-left: 20px;
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .diff-old-value,
        .diff-new-value {
            padding-left: 20px;
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
            margin: 2px 0;
        }

        .diff-item.diff-added {
            background-color: #d1f4d0;
            border-left: 3px solid #1a7f37;
        }

        .diff-item.diff-added .diff-path {
            color: #1a7f37;
        }

        .diff-item.diff-removed {
            background-color: #ffd7d5;
            border-left: 3px solid #d1242f;
        }

        .diff-item.diff-removed .diff-path {
            color: #d1242f;
        }

        .diff-item.diff-changed {
            background-color: #fff8c5;
            border-left: 3px solid #bf8700;
        }

        .diff-item.diff-changed .diff-path {
            color: #bf8700;
        }

        .diff-old-value {
            background-color: #ffd7d5;
            color: #d1242f;
            padding: 2px 8px;
            border-radius: 3px;
            margin: 2px 0;
        }

        .diff-new-value {
            background-color: #d1f4d0;
            color: #1a7f37;
            padding: 2px 8px;
            border-radius: 3px;
            margin: 2px 0;
        }
    </style>
</head>

<body>
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Left Sidebar (25% width) -->
            <div class="col-3 sidebar">
                <div class="search-box">
                    <h5 class="mb-3">Rawlog Items</h5>
                    <input type="text" id="searchInput" class="form-control form-control-sm"
                        placeholder="Search rawlogs...">
                </div>

                <div class="p-3">
                    <div id="loadingRawlogs" class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading rawlogs...</span>
                        </div>
                    </div>

                    <div id="errorRawlogs" class="error d-none">
                        <strong>Error:</strong> <span id="errorMessage"></span>
                    </div>

                    <div id="rawlogsList" class="d-none">
                        <!-- Rawlog items will be populated here -->
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Instructions:</strong><br>
                            • Click rawlog items to expand requests<br>
                            • Left click requests for Slot 1 (blue)<br>
                            • Right click requests for Slot 2 (green)<br>
                            • Select two requests to compare
                        </small>
                    </div>
                </div>
            </div>

            <!-- Main Content Area (75% width) -->
            <div class="col-9 main-content">
                <div class="controls-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Rawlog Comparison</h4>
                        <div>
                            <button id="clearSelections" class="btn btn-outline-secondary btn-sm me-2">Clear
                                Selections</button>
                            <button id="compareBtn" class="btn btn-primary btn-sm me-2" disabled>Compare</button>
                            <button id="exportDiff" class="btn btn-outline-info btn-sm me-2" disabled>Export
                                Diff</button>
                            <button id="ignoreSettings" class="btn btn-outline-warning btn-sm me-2"
                                data-bs-toggle="modal" data-bs-target="#ignoreModal">Ignore Settings</button>
                            <div class="btn-group btn-group-sm ms-2" role="group">
                                <input type="radio" class="btn-check" name="viewMode" id="diffView" checked>
                                <label class="btn btn-outline-primary" for="diffView">Diff View</label>

                                <input type="radio" class="btn-check" name="viewMode" id="rawView">
                                <label class="btn btn-outline-primary" for="rawView">Raw View</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3">
                    <!-- Comparison Slots -->
                    <div class="row mb-4">
                        <div class="col-6">
                            <div id="slot1" class="comparison-slot slot1 p-3">
                                <div class="text-center text-muted">
                                    <h6>Slot 1 <span class="badge badge-slot1">Blue</span></h6>
                                    <p class="mb-0">Left click a rawlog item to select</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div id="slot2" class="comparison-slot slot2 p-3">
                                <div class="text-center text-muted">
                                    <h6>Slot 2 <span class="badge badge-slot2">Green</span></h6>
                                    <p class="mb-0">Right click a rawlog item to select</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Diff/Raw View Area -->
                    <div id="viewArea">
                        <div id="diffViewContent">
                            <div id="loadingDiff" class="loading d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Comparing rawlogs...</span>
                                </div>
                            </div>

                            <div id="errorDiff" class="error d-none">
                                <strong>Error:</strong> <span id="diffErrorMessage"></span>
                            </div>

                            <div id="diffResult" class="diff-container p-3 d-none">
                                <!-- Diff results will be displayed here -->
                            </div>

                            <div id="noDiff" class="text-center text-muted py-5">
                                <h5>Select two rawlogs to compare</h5>
                                <p>Choose items from the sidebar to see their differences</p>
                            </div>
                        </div>

                        <div id="rawViewContent" class="d-none">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Side-by-Side JSON Comparison</h6>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button id="expandJsonViews" class="btn btn-outline-secondary"
                                                title="Expand JSON views">
                                                <i class="fas fa-expand-arrows-alt"></i> Expand
                                            </button>
                                            <button id="copyJsonComparison" class="btn btn-outline-primary"
                                                title="Copy both JSON objects">
                                                <i class="fas fa-copy"></i> Copy Both
                                            </button>
                                            <button id="formatJsonViews" class="btn btn-outline-success"
                                                title="Reformat JSON">
                                                <i class="fas fa-code"></i> Format
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="json-container">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">Slot 1 Raw JSON <span class="badge badge-slot1">Blue</span>
                                            </h6>
                                            <div class="json-controls">
                                                <button class="btn btn-outline-secondary copy-json"
                                                    data-target="rawSlot1" title="Copy JSON">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="json-search">
                                            <input type="text" class="form-control form-control-sm json-search-input"
                                                placeholder="Search in Slot 1 JSON..." data-target="rawSlot1">
                                        </div>
                                        <div id="rawSlot1" class="json-display expandable">No selection</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="json-container">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">Slot 2 Raw JSON <span
                                                    class="badge badge-slot2">Green</span></h6>
                                            <div class="json-controls">
                                                <button class="btn btn-outline-secondary copy-json"
                                                    data-target="rawSlot2" title="Copy JSON">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="json-search">
                                            <input type="text" class="form-control form-control-sm json-search-input"
                                                placeholder="Search in Slot 2 JSON..." data-target="rawSlot2">
                                        </div>
                                        <div id="rawSlot2" class="json-display expandable">No selection</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ignore Settings Modal -->
    <div class="modal fade" id="ignoreModal" tabindex="-1" aria-labelledby="ignoreModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ignoreModalLabel">Ignore Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Parameters to Ignore</h6>
                        <p class="text-muted small">Specify query parameters or headers to exclude from comparison. One
                            per line.</p>

                        <div class="row">
                            <div class="col-6">
                                <label for="ignoreQueryParams" class="form-label">Query Parameters</label>
                                <textarea id="ignoreQueryParams" class="form-control" rows="6"
                                    placeholder="v&#10;tid&#10;_p&#10;timestamp"></textarea>
                                <small class="form-text text-muted">Common examples: v, tid, _p, timestamp, _r</small>
                            </div>
                            <div class="col-6">
                                <label for="ignoreHeaders" class="form-label">HTTP Headers</label>
                                <textarea id="ignoreHeaders" class="form-control" rows="6"
                                    placeholder="user-agent&#10;x-forwarded-for&#10;x-real-ip"></textarea>
                                <small class="form-text text-muted">Common examples: user-agent, x-forwarded-for,
                                    cookie</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Diff Options</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ignoreArrayOrder" checked>
                            <label class="form-check-label" for="ignoreArrayOrder">
                                Ignore array order differences
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ignoreCase">
                            <label class="form-check-label" for="ignoreCase">
                                Case-insensitive comparison for string values
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showOnlyDiffs">
                            <label class="form-check-label" for="showOnlyDiffs">
                                Show only differences (hide unchanged values)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Presets</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                id="presetDefault">Default</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="presetGA">Google
                                Analytics</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                id="presetCustom">Custom</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="applyIgnoreSettings">Apply Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery 3.7 CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JSON Diff Library CDN -->
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/jsondiffpatch.umd.min.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/formatters/html.min.js"></script>

    <script>
        // Global state
        let rawlogs = [];
        let selectedSlot1 = null;
        let selectedSlot2 = null;
        let slot1Data = null;
        let slot2Data = null;
        let expandedRawlogs = new Set(); // Track which rawlogs are expanded
        let rawlogRequests = {}; // Cache requests for each rawlog

        // Ignore settings
        let ignoreSettings = {
            queryParams: [],
            headers: [],
            ignoreArrayOrder: true,
            ignoreCase: false,
            showOnlyDiffs: false
        };

        // Initialize jsondiffpatch - will be recreated when settings change
        let jsondiffpatch = null;

        $(document).ready(function () {
            // Wait a bit for all scripts to load, then initialize
            setTimeout(function () {
                jsondiffpatch = createDiffInstance();
                loadRawlogs();
                setupEventHandlers();
                loadIgnoreSettings();
            }, 100);
        });

        function createDiffInstance() {
            if (typeof window.jsondiffpatch === 'undefined') {
                console.error('jsondiffpatch library not loaded. Diff functionality will be disabled.');
                return null;
            }

            return window.jsondiffpatch.create({
                objectHash: function (obj, index) {
                    return obj.id || obj._id || '$$index:' + index;
                },
                arrays: {
                    detectMove: ignoreSettings.ignoreArrayOrder,
                    includeValueOnMove: false
                },
                textDiff: {
                    minLength: 60
                },
                propertyFilter: function (name, context) {
                    // Ignore specific query params and headers
                    if (context.left && typeof context.left === 'object') {
                        if (context.left.query_params && ignoreSettings.queryParams.includes(name)) {
                            return false;
                        }
                        if (context.left.headers && ignoreSettings.headers.includes(name.toLowerCase())) {
                            return false;
                        }
                    }
                    return true;
                }
            });
        }

        function applyDataFilters(data) {
            if (!data) return data;

            const filtered = JSON.parse(JSON.stringify(data)); // Deep clone

            // Remove ignored query params
            if (filtered.query_params) {
                ignoreSettings.queryParams.forEach(param => {
                    delete filtered.query_params[param];
                });
            }

            // Remove ignored headers
            if (filtered.headers) {
                ignoreSettings.headers.forEach(header => {
                    delete filtered.headers[header.toLowerCase()];
                });
            }

            // Apply case-insensitive comparison if enabled
            if (ignoreSettings.ignoreCase) {
                filtered = normalizeStringCase(filtered);
            }

            return filtered;
        }

        function normalizeStringCase(obj) {
            if (typeof obj === 'string') {
                return obj.toLowerCase();
            } else if (Array.isArray(obj)) {
                return obj.map(normalizeStringCase);
            } else if (obj && typeof obj === 'object') {
                const normalized = {};
                Object.keys(obj).forEach(key => {
                    normalized[key] = normalizeStringCase(obj[key]);
                });
                return normalized;
            }
            return obj;
        }

        function loadIgnoreSettings() {
            // Load settings from localStorage if available
            const saved = localStorage.getItem('rawlogDebuggerIgnoreSettings');
            if (saved) {
                try {
                    ignoreSettings = { ...ignoreSettings, ...JSON.parse(saved) };
                    updateIgnoreUI();
                } catch (e) {
                    console.warn('Failed to load ignore settings:', e);
                }
            }
        }

        function saveIgnoreSettings() {
            localStorage.setItem('rawlogDebuggerIgnoreSettings', JSON.stringify(ignoreSettings));
        }

        function updateIgnoreUI() {
            $('#ignoreQueryParams').val(ignoreSettings.queryParams.join('\n'));
            $('#ignoreHeaders').val(ignoreSettings.headers.join('\n'));
            $('#ignoreArrayOrder').prop('checked', ignoreSettings.ignoreArrayOrder);
            $('#ignoreCase').prop('checked', ignoreSettings.ignoreCase);
            $('#showOnlyDiffs').prop('checked', ignoreSettings.showOnlyDiffs);
        }

        function setupEventHandlers() {
            // Search functionality
            $('#searchInput').on('input', function () {
                const searchTerm = $(this).val().toLowerCase();
                filterRawlogs(searchTerm);
            });

            // Clear selections
            $('#clearSelections').click(function () {
                clearSelections();
            });

            // Compare button
            $('#compareBtn').click(function () {
                performComparison();
            });

            // Export diff
            $('#exportDiff').click(function () {
                exportDiffResults();
            });

            // View mode toggle
            $('input[name="viewMode"]').change(function () {
                toggleViewMode($(this).attr('id'));
            });

            // Prevent context menu on right click
            $(document).on('contextmenu', '.rawlog-item', function (e) {
                e.preventDefault();
                return false;
            });

            // Ignore settings handlers
            $('#applyIgnoreSettings').click(function () {
                applyIgnoreSettings();
            });

            $('#presetDefault').click(function () {
                setIgnorePreset('default');
            });

            $('#presetGA').click(function () {
                setIgnorePreset('ga');
            });

            $('#presetCustom').click(function () {
                setIgnorePreset('custom');
            });

            // JSON view controls
            $('#expandJsonViews').click(function () {
                expandJsonViews();
            });

            $('#copyJsonComparison').click(function () {
                copyJsonComparison();
            });

            $('#formatJsonViews').click(function () {
                formatJsonViews();
            });

            // Copy individual JSON buttons
            $(document).on('click', '.copy-json', function () {
                const targetId = $(this).data('target');
                copyJsonContent(targetId);
            });

            // JSON search functionality
            $(document).on('input', '.json-search-input', function () {
                const searchTerm = $(this).val();
                const targetId = $(this).data('target');
                searchInJson(targetId, searchTerm);
            });
        }

        function loadRawlogs() {
            $('#loadingRawlogs').removeClass('d-none');
            $('#errorRawlogs').addClass('d-none');
            $('#rawlogsList').addClass('d-none');

            $.ajax({
                url: '/api/rawlogs',
                method: 'GET',
                timeout: 10000
            })
                .done(function (response) {
                    if (response.success) {
                        rawlogs = response.data || [];
                        renderRawlogsList();
                        $('#loadingRawlogs').addClass('d-none');
                        $('#rawlogsList').removeClass('d-none');
                    } else {
                        throw new Error(response.error || 'Failed to load rawlogs');
                    }
                })
                .fail(function (xhr, status, error) {
                    let errorMsg = 'Failed to load rawlogs';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    } else if (error) {
                        errorMsg = error;
                    }
                    $('#errorMessage').text(errorMsg);
                    $('#loadingRawlogs').addClass('d-none');
                    $('#errorRawlogs').removeClass('d-none');
                });
        }

        function renderRawlogsList() {
            const container = $('#rawlogsList');
            container.empty();

            if (rawlogs.length === 0) {
                container.html('<p class="text-muted">No rawlogs found</p>');
                return;
            }

            rawlogs.forEach(function (rawlog) {
                const isExpanded = expandedRawlogs.has(rawlog.ID);
                const item = $(`
                    <div class="rawlog-group mb-2">
                        <div class="rawlog-item p-2 ${isExpanded ? 'expanded' : ''}" data-id="${rawlog.ID}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div>
                                        <i class="fas fa-chevron-right expand-icon ${isExpanded ? 'expanded' : ''}"></i>
                                        <span class="fw-bold">${rawlog.ID}</span>
                                    </div>
                                    <small class="text-muted">${rawlog.FormattedTime}</small>
                                </div>
                                <div class="text-muted">
                                    <small>Click to expand</small>
                                </div>
                            </div>
                        </div>
                        <div class="rawlog-requests ${isExpanded ? 'show' : ''}" data-rawlog-id="${rawlog.ID}">
                            <!-- Requests will be loaded here -->
                        </div>
                    </div>
                `);

                // Click to expand/collapse rawlog
                item.find('.rawlog-item').on('click', function (e) {
                    e.preventDefault();
                    toggleRawlogExpansion(rawlog.ID);
                });

                container.append(item);
            });

            // Load requests for already expanded rawlogs
            expandedRawlogs.forEach(rawlogId => {
                loadRequestsForRawlog(rawlogId);
            });

            updateSelectionVisuals();
        }

        function filterRawlogs(searchTerm) {
            $('.rawlog-group').each(function () {
                const text = $(this).text().toLowerCase();
                if (text.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }

        function toggleRawlogExpansion(rawlogId) {
            const isExpanded = expandedRawlogs.has(rawlogId);
            const rawlogItem = $(`.rawlog-item[data-id="${rawlogId}"]`);
            const requestsContainer = $(`.rawlog-requests[data-rawlog-id="${rawlogId}"]`);
            const expandIcon = rawlogItem.find('.expand-icon');

            if (isExpanded) {
                // Collapse
                expandedRawlogs.delete(rawlogId);
                rawlogItem.removeClass('expanded');
                requestsContainer.removeClass('show');
                expandIcon.removeClass('expanded');
            } else {
                // Expand
                expandedRawlogs.add(rawlogId);
                rawlogItem.addClass('expanded');
                requestsContainer.addClass('show');
                expandIcon.addClass('expanded');

                // Load requests if not already cached
                loadRequestsForRawlog(rawlogId);
            }
        }

        function loadRequestsForRawlog(rawlogId) {
            const requestsContainer = $(`.rawlog-requests[data-rawlog-id="${rawlogId}"]`);

            // Check if already loaded
            if (rawlogRequests[rawlogId]) {
                renderRequestsInContainer(requestsContainer, rawlogRequests[rawlogId], rawlogId);
                return;
            }

            // Show loading
            requestsContainer.html('<div class="text-center p-2"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>');

            // Fetch rawlog content and parse requests
            $.ajax({
                url: `/api/rawlog/${rawlogId}`,
                method: 'GET',
                timeout: 10000
            })
                .done(function (response) {
                    if (response.success) {
                        const requests = response.data || [];
                        rawlogRequests[rawlogId] = requests;
                        renderRequestsInContainer(requestsContainer, requests, rawlogId);
                    } else {
                        requestsContainer.html('<div class="text-danger p-2"><small>Failed to load requests</small></div>');
                    }
                })
                .fail(function (xhr, status, error) {
                    let errorMsg = 'Failed to load requests';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    requestsContainer.html(`<div class="text-danger p-2"><small>${errorMsg}</small></div>`);
                });
        }

        function renderRequestsInContainer(container, requests, rawlogId) {
            container.empty();

            if (requests.length === 0) {
                container.html('<div class="text-muted p-2"><small>No requests found</small></div>');
                return;
            }

            requests.forEach(function (request, index) {
                const requestId = `${rawlogId}_${index}`;
                const requestItem = $(`
                    <div class="request-item" data-id="${requestId}" data-rawlog-id="${rawlogId}" data-request-index="${index}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="fw-bold">${request.metadata.method || 'N/A'} ${request.metadata.path || 'N/A'}</div>
                                <small class="text-muted">
                                    Params: ${Object.keys(request.query_params || {}).length}, 
                                    Headers: ${Object.keys(request.headers || {}).length}
                                </small>
                            </div>
                            <div class="badges">
                                <!-- Badges will be updated by updateSelectionVisuals -->
                            </div>
                        </div>
                    </div>
                `);

                // Left click for slot 1
                requestItem.on('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectRequestForSlot(requestId, rawlogId, index, 1);
                });

                // Right click for slot 2
                requestItem.on('mousedown', function (e) {
                    if (e.which === 3) { // Right click
                        e.preventDefault();
                        e.stopPropagation();
                        selectRequestForSlot(requestId, rawlogId, index, 2);
                        return false;
                    }
                });

                // Prevent context menu on right click
                requestItem.on('contextmenu', function (e) {
                    e.preventDefault();
                    return false;
                });

                container.append(requestItem);
            });

            updateSelectionVisuals();
        }

        function selectRequestForSlot(requestId, rawlogId, requestIndex, slotNumber) {
            if (slotNumber === 1) {
                selectedSlot1 = requestId;
                slot1Data = null;
            } else {
                selectedSlot2 = requestId;
                slot2Data = null;
            }

            updateSelectionVisuals();
            updateSlotDisplay(slotNumber, requestId, rawlogId, requestIndex);
            updateCompareButton();
        }

        function updateSelectionVisuals() {
            $('.request-item').removeClass('selected-slot1 selected-slot2');

            if (selectedSlot1) {
                $(`.request-item[data-id="${selectedSlot1}"]`).addClass('selected-slot1');
            }

            if (selectedSlot2) {
                $(`.request-item[data-id="${selectedSlot2}"]`).addClass('selected-slot2');
            }

            // Update badges
            $('.request-item .badges').empty();
            $('.request-item').each(function () {
                const id = $(this).data('id');
                const badges = $(this).find('.badges');

                if (selectedSlot1 === id) {
                    badges.append('<span class="badge badge-slot1">1</span>');
                }
                if (selectedSlot2 === id) {
                    badges.append('<span class="badge badge-slot2">2</span>');
                }
            });
        }

        function updateSlotDisplay(slotNumber, requestId, rawlogId, requestIndex) {
            const rawlog = rawlogs.find(r => r.ID === rawlogId);
            const requests = rawlogRequests[rawlogId];
            const request = requests ? requests[requestIndex] : null;
            const slotElement = $(`#slot${slotNumber}`);

            slotElement.addClass('has-content');

            let displayContent = `
                <div>
                    <h6>Slot ${slotNumber} <span class="badge badge-slot${slotNumber}">${slotNumber === 1 ? 'Blue' : 'Green'}</span></h6>
                    <div class="fw-bold">Request ${requestId}</div>
                    <small class="text-muted">${rawlog ? rawlog.FormattedTime : 'Unknown time'}</small>
                </div>
            `;

            if (request) {
                displayContent += `
                    <div class="mt-2">
                        <div><strong>Method:</strong> ${request.metadata.method || 'N/A'}</div>
                        <div><strong>Path:</strong> ${request.metadata.path || 'N/A'}</div>
                        <div><strong>Params:</strong> ${Object.keys(request.query_params || {}).length}</div>
                        <div><strong>Headers:</strong> ${Object.keys(request.headers || {}).length}</div>
                    </div>
                `;
            }

            slotElement.html(displayContent);
        }

        function updateCompareButton() {
            const canCompare = selectedSlot1 && selectedSlot2 && selectedSlot1 !== selectedSlot2;
            $('#compareBtn').prop('disabled', !canCompare);
        }

        function clearSelections() {
            selectedSlot1 = null;
            selectedSlot2 = null;
            slot1Data = null;
            slot2Data = null;

            $('#slot1').removeClass('has-content').html(`
                <div class="text-center text-muted">
                    <h6>Slot 1 <span class="badge badge-slot1">Blue</span></h6>
                    <p class="mb-0">Left click a request to select</p>
                </div>
            `);

            $('#slot2').removeClass('has-content').html(`
                <div class="text-center text-muted">
                    <h6>Slot 2 <span class="badge badge-slot2">Green</span></h6>
                    <p class="mb-0">Right click a request to select</p>
                </div>
            `);

            updateSelectionVisuals();
            updateCompareButton();

            $('#diffResult').addClass('d-none');
            $('#noDiff').removeClass('d-none');
            $('#exportDiff').prop('disabled', true);

            $('#rawSlot1, #rawSlot2').text('No selection');
        }

        function performComparison() {
            if (!selectedSlot1 || !selectedSlot2) {
                return;
            }

            $('#loadingDiff').removeClass('d-none');
            $('#errorDiff').addClass('d-none');
            $('#diffResult').addClass('d-none');
            $('#noDiff').addClass('d-none');

            const promises = [];

            // Load slot 1 data if not cached
            if (!slot1Data) {
                promises.push(loadRequestData(selectedSlot1).then(data => slot1Data = data));
            }

            // Load slot 2 data if not cached
            if (!slot2Data) {
                promises.push(loadRequestData(selectedSlot2).then(data => slot2Data = data));
            }

            Promise.all(promises)
                .then(() => {
                    // Apply filters to data before comparison
                    const filteredSlot1 = applyDataFilters(slot1Data);
                    const filteredSlot2 = applyDataFilters(slot2Data);

                    // Use our new GitHub-style diff display
                    displayDiff(null, filteredSlot1);
                    updateRawView();
                    $('#loadingDiff').addClass('d-none');
                    $('#exportDiff').prop('disabled', false);
                })
                .catch(error => {
                    console.error('Comparison error:', error);
                    $('#diffErrorMessage').text('Failed to compare requests: ' + error.message);
                    $('#loadingDiff').addClass('d-none');
                    $('#errorDiff').removeClass('d-none');
                });
        }

        function loadRequestData(requestId) {
            return new Promise((resolve, reject) => {
                // Parse requestId to get rawlogId and index
                const parts = requestId.split('_');
                if (parts.length !== 2) {
                    reject(new Error('Invalid request ID format'));
                    return;
                }

                const rawlogId = parts[0];
                const requestIndex = parseInt(parts[1], 10);

                // Check if we already have the requests cached
                if (rawlogRequests[rawlogId]) {
                    const request = rawlogRequests[rawlogId][requestIndex];
                    if (request) {
                        resolve(request);
                        return;
                    } else {
                        reject(new Error('Request index out of range'));
                        return;
                    }
                }

                // Load the rawlog and extract the specific request
                $.ajax({
                    url: `/api/rawlog/${rawlogId}`,
                    method: 'GET',
                    timeout: 10000
                })
                    .done(function (response) {
                        if (response.success) {
                            const requests = response.data || [];
                            rawlogRequests[rawlogId] = requests;

                            if (requestIndex >= 0 && requestIndex < requests.length) {
                                resolve(requests[requestIndex]);
                            } else {
                                reject(new Error('Request index out of range'));
                            }
                        } else {
                            reject(new Error(response.error || 'Failed to load rawlog data'));
                        }
                    })
                    .fail((xhr, status, error) => {
                        let errorMsg = 'Failed to load rawlog data';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        reject(new Error(errorMsg));
                    });
            });
        }

        function deepEqual(obj1, obj2) {
            if (obj1 === obj2) return true;

            if (obj1 == null || obj2 == null) return obj1 === obj2;

            if (typeof obj1 !== typeof obj2) return false;

            if (typeof obj1 !== 'object') return obj1 === obj2;

            if (Array.isArray(obj1) !== Array.isArray(obj2)) return false;

            if (Array.isArray(obj1)) {
                if (obj1.length !== obj2.length) return false;
                for (let i = 0; i < obj1.length; i++) {
                    if (!deepEqual(obj1[i], obj2[i])) return false;
                }
                return true;
            }

            const keys1 = Object.keys(obj1);
            const keys2 = Object.keys(obj2);

            if (keys1.length !== keys2.length) return false;

            for (const key of keys1) {
                if (!keys2.includes(key)) return false;
                if (!deepEqual(obj1[key], obj2[key])) return false;
            }

            return true;
        }

        function generateSmartDiff(obj1, obj2, path = '') {
            const differences = [];

            function findDifferences(o1, o2, currentPath) {
                if (deepEqual(o1, o2)) return;

                if (typeof o1 !== typeof o2 || o1 == null || o2 == null) {
                    differences.push({
                        path: currentPath,
                        type: 'changed',
                        oldValue: o1,
                        newValue: o2
                    });
                    return;
                }

                if (Array.isArray(o1) && Array.isArray(o2)) {
                    const maxLen = Math.max(o1.length, o2.length);
                    for (let i = 0; i < maxLen; i++) {
                        const itemPath = currentPath ? `${currentPath}[${i}]` : `[${i}]`;
                        if (i >= o1.length) {
                            differences.push({
                                path: itemPath,
                                type: 'added',
                                newValue: o2[i]
                            });
                        } else if (i >= o2.length) {
                            differences.push({
                                path: itemPath,
                                type: 'removed',
                                oldValue: o1[i]
                            });
                        } else {
                            findDifferences(o1[i], o2[i], itemPath);
                        }
                    }
                    return;
                }

                if (typeof o1 === 'object' && typeof o2 === 'object') {
                    const allKeys = new Set([...Object.keys(o1), ...Object.keys(o2)]);
                    for (const key of allKeys) {
                        const keyPath = currentPath ? `${currentPath}.${key}` : key;
                        if (!(key in o1)) {
                            differences.push({
                                path: keyPath,
                                type: 'added',
                                newValue: o2[key]
                            });
                        } else if (!(key in o2)) {
                            differences.push({
                                path: keyPath,
                                type: 'removed',
                                oldValue: o1[key]
                            });
                        } else {
                            findDifferences(o1[key], o2[key], keyPath);
                        }
                    }
                    return;
                }

                differences.push({
                    path: currentPath,
                    type: 'changed',
                    oldValue: o1,
                    newValue: o2
                });
            }

            findDifferences(obj1, obj2, path);
            return differences;
        }

        function generateGitHubStyleDiff(obj1, obj2) {
            // Sort keys for consistent comparison
            const sortedObj1 = sortObjectKeys(obj1);
            const sortedObj2 = sortObjectKeys(obj2);

            // First check if they're actually different
            if (deepEqual(sortedObj1, sortedObj2)) {
                return '<div class="text-center text-success py-4"><h6>Objects are identical</h6></div>';
            }

            // Get smart differences
            const differences = generateSmartDiff(sortedObj1, sortedObj2);

            if (differences.length === 0) {
                return '<div class="text-center text-success py-4"><h6>No meaningful differences found</h6></div>';
            }

            // Generate HTML for differences
            let diffHtml = '<div class="smart-diff-container">';

            differences.forEach((diff, index) => {
                const pathHtml = escapeHtml(diff.path || 'root');

                if (diff.type === 'added') {
                    diffHtml += `<div class="diff-item diff-added">
                        <div class="diff-path">+ ${pathHtml}</div>
                        <div class="diff-value">${escapeHtml(JSON.stringify(diff.newValue, null, 2))}</div>
                    </div>`;
                } else if (diff.type === 'removed') {
                    diffHtml += `<div class="diff-item diff-removed">
                        <div class="diff-path">- ${pathHtml}</div>
                        <div class="diff-value">${escapeHtml(JSON.stringify(diff.oldValue, null, 2))}</div>
                    </div>`;
                } else if (diff.type === 'changed') {
                    diffHtml += `<div class="diff-item diff-changed">
                        <div class="diff-path">~ ${pathHtml}</div>
                        <div class="diff-old-value">- ${escapeHtml(JSON.stringify(diff.oldValue, null, 2))}</div>
                        <div class="diff-new-value">+ ${escapeHtml(JSON.stringify(diff.newValue, null, 2))}</div>
                    </div>`;
                }
            });

            diffHtml += '</div>';
            return diffHtml;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayDiff(delta, leftData) {
            const diffContainer = $('#diffResult');

            if (!slot1Data || !slot2Data) {
                diffContainer.html(`
                    <div class="text-center text-warning py-4">
                        <h5>Cannot Generate Diff</h5>
                        <p>Both slots must be selected to compare</p>
                    </div>
                `);
                diffContainer.removeClass('d-none');
                return;
            }

            // Check if objects are identical after applying filters
            const filteredSlot1 = applyDataFilters(slot1Data);
            const filteredSlot2 = applyDataFilters(slot2Data);

            if (JSON.stringify(sortObjectKeys(filteredSlot1)) === JSON.stringify(sortObjectKeys(filteredSlot2))) {
                diffContainer.html(`
                    <div class="text-center text-success py-4">
                        <h5>No Differences Found</h5>
                        <p>The selected rawlogs are identical</p>
                        ${ignoreSettings.queryParams.length > 0 || ignoreSettings.headers.length > 0 ?
                        '<small class="text-muted">(Some parameters/headers were ignored in comparison)</small>' : ''}
                    </div>
                `);
            } else {
                const ignoredInfo = [];
                if (ignoreSettings.queryParams.length > 0) {
                    ignoredInfo.push(`Query params: ${ignoreSettings.queryParams.join(', ')}`);
                }
                if (ignoreSettings.headers.length > 0) {
                    ignoredInfo.push(`Headers: ${ignoreSettings.headers.join(', ')}`);
                }

                const diffHtml = generateGitHubStyleDiff(filteredSlot1, filteredSlot2);

                diffContainer.html(`
                    <div class="mb-3">
                        <h6>Smart Diff View</h6>
                        <div class="d-flex gap-3 mb-3">
                            <div><span class="badge bg-success">+ Added</span> New in Slot 2</div>
                            <div><span class="badge bg-danger">- Removed</span> Missing from Slot 2</div>
                            <div><span class="badge bg-warning">~ Changed</span> Modified values</div>
                        </div>
                        ${ignoredInfo.length > 0 ?
                        `<div class="alert alert-info py-2">
                                <small><strong>Ignored:</strong> ${ignoredInfo.join(' | ')}</small>
                            </div>` : ''}
                    </div>
                    <div class="github-style-diff">${diffHtml}</div>
                `);
            }

            diffContainer.removeClass('d-none');
        }

        function displayDiffError(message) {
            const diffContainer = $('#diffResult');
            diffContainer.html(`
                <div class="text-center text-danger py-4">
                    <h5>Diff Error</h5>
                    <p>${message}</p>
                    <small class="text-muted">You can still view the raw JSON data using the "Raw View" tab</small>
                </div>
            `);
            diffContainer.removeClass('d-none');
        }

        function sortObjectKeys(obj) {
            if (Array.isArray(obj)) {
                return obj.map(sortObjectKeys);
            } else if (obj !== null && typeof obj === 'object') {
                return Object.keys(obj).sort().reduce((result, key) => {
                    result[key] = sortObjectKeys(obj[key]);
                    return result;
                }, {});
            }
            return obj;
        }

        function updateRawView() {
            // Sort JSON keys before displaying for consistent comparison
            const sortedSlot1 = slot1Data ? sortObjectKeys(slot1Data) : null;
            const sortedSlot2 = slot2Data ? sortObjectKeys(slot2Data) : null;

            const slot1Text = sortedSlot1 ? JSON.stringify(sortedSlot1, null, 2) : 'No selection';
            const slot2Text = sortedSlot2 ? JSON.stringify(sortedSlot2, null, 2) : 'No selection';

            $('#rawSlot1').text(slot1Text);
            $('#rawSlot2').text(slot2Text);

            // Clear any previous search highlights
            clearJsonSearchHighlights();
        }

        function toggleViewMode(viewMode) {
            if (viewMode === 'diffView') {
                $('#diffViewContent').removeClass('d-none');
                $('#rawViewContent').addClass('d-none');
            } else {
                $('#diffViewContent').addClass('d-none');
                $('#rawViewContent').removeClass('d-none');
            }
        }

        function exportDiffResults() {
            if (!slot1Data || !slot2Data) {
                alert('No comparison data to export');
                return;
            }

            const sortedSlot1 = sortObjectKeys(slot1Data);
            const sortedSlot2 = sortObjectKeys(slot2Data);

            const exportData = {
                timestamp: new Date().toISOString(),
                slot1: {
                    id: selectedSlot1,
                    data: sortedSlot1
                },
                slot2: {
                    id: selectedSlot2,
                    data: sortedSlot2
                },
                comparison_notes: {
                    keys_sorted: true,
                    diff_style: 'github_style_line_by_line',
                    ignored_params: ignoreSettings.queryParams,
                    ignored_headers: ignoreSettings.headers
                }
            };

            const blob = new Blob([JSON.stringify(sortObjectKeys(exportData), null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rawlog-diff-${selectedSlot1}-vs-${selectedSlot2}-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function applyIgnoreSettings() {
            // Get values from modal
            const queryParamsText = $('#ignoreQueryParams').val().trim();
            const headersText = $('#ignoreHeaders').val().trim();

            ignoreSettings.queryParams = queryParamsText ? queryParamsText.split('\n').map(s => s.trim()).filter(s => s) : [];
            ignoreSettings.headers = headersText ? headersText.split('\n').map(s => s.trim().toLowerCase()).filter(s => s) : [];
            ignoreSettings.ignoreArrayOrder = $('#ignoreArrayOrder').is(':checked');
            ignoreSettings.ignoreCase = $('#ignoreCase').is(':checked');
            ignoreSettings.showOnlyDiffs = $('#showOnlyDiffs').is(':checked');

            // Recreate diff instance with new settings
            jsondiffpatch = createDiffInstance();

            // Save settings
            saveIgnoreSettings();

            // Close modal
            $('#ignoreModal').modal('hide');

            // Re-run comparison if both slots are selected
            if (selectedSlot1 && selectedSlot2) {
                performComparison();
            }
        }

        function setIgnorePreset(preset) {
            switch (preset) {
                case 'default':
                    $('#ignoreQueryParams').val('');
                    $('#ignoreHeaders').val('');
                    $('#ignoreArrayOrder').prop('checked', true);
                    $('#ignoreCase').prop('checked', false);
                    $('#showOnlyDiffs').prop('checked', false);
                    break;

                case 'ga':
                    $('#ignoreQueryParams').val('v\ntid\n_p\n_r\ntimestamp\n_s\n_v\n_u\n_gid\n_rid');
                    $('#ignoreHeaders').val('user-agent\nx-forwarded-for\nx-real-ip\ncookie\nreferer\naccept-encoding\naccept-language');
                    $('#ignoreArrayOrder').prop('checked', true);
                    $('#ignoreCase').prop('checked', true);
                    $('#showOnlyDiffs').prop('checked', false);
                    break;

                case 'custom':
                    // Keep current values, just show the modal
                    break;
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Unknown';

            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp;
            }
        }

        // Enhanced JSON view functions
        function expandJsonViews() {
            $('.json-display').animate({ 'max-height': '800px' }, 300);
            $('#expandJsonViews').html('<i class="fas fa-compress-arrows-alt"></i> Collapse').off('click').click(function () {
                $('.json-display').animate({ 'max-height': '600px' }, 300);
                $(this).html('<i class="fas fa-expand-arrows-alt"></i> Expand').off('click').click(expandJsonViews);
            });
        }

        function copyJsonComparison() {
            const slot1Text = $('#rawSlot1').text();
            const slot2Text = $('#rawSlot2').text();

            if (slot1Text === 'No selection' || slot2Text === 'No selection') {
                showToast('Please select both slots before copying', 'warning');
                return;
            }

            const comparisonData = {
                slot1: {
                    id: selectedSlot1,
                    data: sortObjectKeys(slot1Data)
                },
                slot2: {
                    id: selectedSlot2,
                    data: sortObjectKeys(slot2Data)
                },
                timestamp: new Date().toISOString()
            };

            copyToClipboard(JSON.stringify(sortObjectKeys(comparisonData), null, 2))
                .then(() => showToast('Comparison data copied to clipboard with sorted keys!', 'success'))
                .catch(() => showToast('Failed to copy to clipboard', 'error'));
        }

        function formatJsonViews() {
            if (slot1Data) {
                const sortedData1 = sortObjectKeys(slot1Data);
                const formatted1 = JSON.stringify(sortedData1, null, 2);
                $('#rawSlot1').text(formatted1);
            }
            if (slot2Data) {
                const sortedData2 = sortObjectKeys(slot2Data);
                const formatted2 = JSON.stringify(sortedData2, null, 2);
                $('#rawSlot2').text(formatted2);
            }
            showToast('JSON formatting refreshed with sorted keys', 'success');
        }

        function copyJsonContent(targetId) {
            const content = $('#' + targetId).text();
            if (content === 'No selection') {
                showToast('No content to copy', 'warning');
                return;
            }

            copyToClipboard(content)
                .then(() => showToast('JSON copied to clipboard!', 'success'))
                .catch(() => showToast('Failed to copy to clipboard', 'error'));
        }

        function searchInJson(targetId, searchTerm) {
            const container = $('#' + targetId);
            let content = container.text();

            // Remove previous highlights
            content = content.replace(/<mark class="json-highlight">(.*?)<\/mark>/g, '$1');

            if (searchTerm && searchTerm.length > 1) {
                // Escape special regex characters
                const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedTerm})`, 'gi');
                content = content.replace(regex, '<mark class="json-highlight">$1</mark>');
            }

            container.html(content);
        }

        function clearJsonSearchHighlights() {
            $('.json-display').each(function () {
                const content = $(this).text();
                $(this).text(content);
            });
        }

        async function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                return await navigator.clipboard.writeText(text);
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'absolute';
                textArea.style.left = '-999999px';
                document.body.prepend(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                } finally {
                    textArea.remove();
                }
            }
        }

        function showToast(message, type = 'info') {
            // Create a simple toast notification
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : 'bg-info';

            const toast = $(`
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" 
                     style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);

            $('body').append(toast);

            // Initialize and show toast
            const bsToast = new bootstrap.Toast(toast[0], { delay: 3000 });
            bsToast.show();

            // Remove from DOM after hiding
            toast.on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }
    </script>
</body>

</html>